<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Sector Mapper - Map & Export Tool</title>
    <meta name="description"
        content="Create, manage, and visualize telecom sites with sectors. Import from CSV or Airtable, and export to KML format.">

    <title>Site Sector Mapper</title>
    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            alert('Global Error: ' + message + ' at ' + source + ':' + lineno);
        };
    </script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SiteMapper">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/684/684908.png">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css?v=153">
</head>
</head>
</head>
</head>
</head>
</head>

<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-header">
                <h2>Optim Analyzer Pro</h2>
                <p>Please sign in to continue</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter password" autocomplete="current-password">
                </div>
                <button type="submit" class="btn-login">Sign In</button>
                <div id="loginError" class="login-error"></div>
            </form>
            <div class="login-footer">
                <p>Abdelilah ELQORCHI v1.3</p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden by default) -->
    <div id="appContainer" class="app-container hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <circle cx="16" cy="16" r="14" stroke="url(#gradient)" stroke-width="2" />
                        <path d="M16 8 L24 16 L16 12 L8 16 Z" fill="url(#gradient)" />
                        <circle cx="16" cy="16" r="3" fill="url(#gradient)" />
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <h1>Optim Analyzer Pro</h1>
                </div>
                <div class="header-actions">
                    <button id="importSitesBtn" class="btn btn-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                        Import Sites
                    </button>
                    <button id="exportKmlBtn" class="btn btn-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                        Export KML
                    </button>
                    <button id="importKmlHeaderBtn" class="btn btn-secondary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                        Import KML
                    </button>
                    <button id="toggleConnectionLinesBtn" class="btn btn-secondary"
                        title="Draw lines from KML points to sectors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        <span id="connectionBtnText">Lines: Off</span>
                    </button>
                    <button id="connectionSettingsBtn" class="btn btn-secondary" onclick="toggleConnectionSettings()"
                        title="Connection Line Settings">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                    </button>
                    <button id="bulkEditBtn" class="btn btn-primary btn-success">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Bulk Edit
                    </button>
                    <button id="clearAllBtn" class="btn btn-secondary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="3 6 5 6 21 6" />
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                        </svg>
                        Clear All
                    </button>
                    <button id="importAlarmsBtn" class="btn btn-secondary btn-warning">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        Import Alarms
                    </button>
                    <button id="logoutBtn" class="btn btn-secondary btn-danger-outline ml-10">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                        Logout
                    </button>
                    <input type="file" id="alarmFileInput" accept=".xlsx, .xls" hidden>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar Panel -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>Manage Sites</h2>
                    <div class="site-counter">
                        <span id="siteCount">0</span> Sites
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="sites-list">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M3 6h18M3 12h18M3 18h18" />
                        </svg>
                        Sites List
                    </button>
                    <button class="tab-btn" data-tab="kml-list">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        KML List
                    </button>
                    <button class="tab-btn" data-tab="kml">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                        KML Import
                    </button>
                    <button class="tab-btn" data-tab="points-list">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        Points List
                    </button>
                    <button class="tab-btn" data-tab="thematic">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M2 20h20"></path>
                            <path d="M5 20v-4"></path>
                            <path d="M9 20v-8"></path>
                            <path d="M13 20v-12"></path>
                            <path d="M17 20v-16"></path>
                        </svg>
                        Thematic
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Sites List Tab -->
                    <div class="tab-pane active" id="sites-list-tab">
                        <!-- Import Menu -->
                        <div id="importMenu" class="import-menu d-none">
                            <div class="d-flex justify-between align-center mb-3">
                                <h3 class="mb-0">Choose Import Method</h3>
                                <button id="closeImportMenuBtn" class="btn btn-secondary btn-sm">Close</button>
                            </div>
                            <div class="d-flex flex-column gap-3">
                                <button class="btn btn-primary btn-block import-method-btn" data-method="manual">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                                    </svg>
                                    Manual Entry
                                </button>
                                <button class="btn btn-primary btn-block import-method-btn" data-method="csv">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                        <polyline points="14 2 14 8 20 8" />
                                    </svg>
                                    CSV / Excel Import
                                </button>
                                <button class="btn btn-primary btn-block import-method-btn" data-method="airtable">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                        <circle cx="9" cy="7" r="4" />
                                    </svg>
                                    Airtable Import
                                </button>
                                <button id="syncToAirtableBtn" class="btn btn-success btn-block mt-2">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21.5 2v6h-6M21.5 3l-9 9M2.5 22v-6h6M2.5 21l9-9" />
                                    </svg>
                                    Sync All to Airtable
                                </button>
                            </div>
                        </div>

                        <!-- Manual Entry Form -->
                        <div id="manualFormContainer" class="d-none">
                            <div class="d-flex justify-between align-center mb-3">
                                <h3 class="mb-0">Manual Entry</h3>
                                <button id="backFromManualBtn" class="btn btn-secondary btn-sm">← Back</button>
                            </div>
                            <form id="manualForm" class="site-form">
                                <div class="form-group">
                                    <label for="siteName">Site Name *</label>
                                    <input type="text" id="siteName" required placeholder="Enter site name">
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="latitude">Latitude *</label>
                                        <input type="number" id="latitude" step="any" required placeholder="33.5731">
                                    </div>
                                    <div class="form-group">
                                        <label for="longitude">Longitude *</label>
                                        <input type="number" id="longitude" step="any" required placeholder="-7.5898">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="iconShape">Icon Shape</label>
                                        <select id="iconShape">
                                            <option value="default">Default (Pin)</option>
                                            <option value="circle">Circle</option>
                                            <option value="square">Square</option>
                                            <option value="triangle">Triangle</option>
                                            <option value="star">Star</option>
                                            <option value="diamond">Diamond</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="iconSize">Size (px)</label>
                                        <input type="number" id="iconSize" value="30" min="10" max="100">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="iconColor">Icon Color</label>
                                    <div class="d-flex gap-10">
                                        <input type="color" id="iconColor" value="#3b82f6" class="p-0 h-40 w-60">
                                        <input type="text" id="iconColorText" value="#3b82f6" placeholder="#3b82f6"
                                            class="flex-1">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <textarea id="description" rows="3" placeholder="Optional description"></textarea>
                                </div>

                                <div class="sectors-section">
                                    <div class="sectors-header">
                                        <label>Sectors</label>
                                        <button type="button" id="addSectorBtn" class="btn-icon">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <line x1="12" y1="5" x2="12" y2="19" />
                                                <line x1="5" y1="12" x2="19" y2="12" />
                                            </svg>
                                            Add Sector
                                        </button>
                                    </div>
                                    <div id="sectorsContainer" class="sectors-container">
                                        <!-- Sectors will be added dynamically -->
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary btn-block">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M12 5v14M5 12l7 7 7-7" />
                                        </svg>
                                        Add Site
                                    </button>
                                    <button type="button" id="cancelEditBtn" class="btn btn-secondary btn-block d-none">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18" />
                                            <line x1="6" y1="6" x2="18" y2="18" />
                                        </svg>
                                        Cancel Edit
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- CSV Import Form -->
                        <div id="csvFormContainer" class="d-none">
                            <div class="d-flex justify-between align-center mb-3">
                                <h3 class="mb-0">File Import (CSV / Excel)</h3>
                                <button id="backFromCsvBtn" class="btn btn-secondary btn-sm">← Back</button>
                            </div>
                            <div class="upload-section">
                                <div id="dropZone" class="drop-zone">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="1.5">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                        <polyline points="14 2 14 8 20 8" />
                                        <line x1="12" y1="18" x2="12" y2="12" />
                                        <line x1="9" y1="15" x2="15" y2="15" />
                                    </svg>
                                    <p class="drop-text">Drag & drop CSV or Excel file here</p>
                                    <p class="drop-subtext">or</p>
                                    <button type="button" class="btn btn-secondary" id="selectFileBtn">Browse
                                        Files</button>
                                    <input type="file" id="csvFileInput" accept=".csv, .xlsx, .xls" hidden
                                        aria-label="Upload File">
                                </div>

                                <div class="csv-info">
                                    <h3>File Format</h3>
                                    <p>Your file should have the following columns:</p>
                                    <code>site_name,latitude,longitude,description,azimuth,beamwidth,range</code>
                                    <p class="csv-note">Multiple sectors: Add rows with the same site_name but different
                                        sector values.</p>
                                </div>

                                <div id="csvPreview" class="csv-preview d-none">
                                    <h3>Preview</h3>
                                    <div id="csvPreviewContent"></div>
                                    <div class="preview-actions">
                                        <button id="importCsvBtn" class="btn btn-primary">Import Sites</button>
                                        <button id="cancelCsvBtn" class="btn btn-secondary">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Airtable Import Form -->
                        <div id="airtableFormContainer" class="d-none">
                            <div class="d-flex justify-between align-center mb-3">
                                <h3 class="mb-0">Airtable Import</h3>
                                <button id="backFromAirtableBtn" class="btn btn-secondary btn-sm">← Back</button>
                            </div>
                            <form class="airtable-section" onsubmit="return false;">
                                <div class="form-group">
                                    <label for="airtableApiKey">API Key / Personal Access Token</label>
                                    <input type="password" id="airtableApiKey" autocomplete="current-password"
                                        placeholder="Enter your Airtable API key">
                                </div>

                                <div class="form-group">
                                    <label for="airtableBaseId">Base ID</label>
                                    <input type="text" id="airtableBaseId" placeholder="appXXXXXXXXXXXXXX"
                                        autocomplete="username">
                                </div>

                                <div class="form-group">
                                    <label for="airtableTableName">Table Name</label>
                                    <input type="text" id="airtableTableName" placeholder="Sites">
                                </div>

                                <button id="connectAirtableBtn" type="button" class="btn btn-primary btn-block">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path
                                            d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
                                    </svg>
                                    Fetch from Airtable
                                </button>

                                <div id="airtableStatus" class="status-message d-none"></div>
                            </form>
                        </div>
                    </div>

                    <!-- KML Import Tab -->
                    <div class="tab-pane" id="kml-tab">
                        <div class="upload-section">
                            <div id="kmlDropZone" class="drop-zone">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="1.5">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="7 10 12 15 17 10" />
                                    <line x1="12" y1="15" x2="12" y2="3" />
                                </svg>
                                <p class="drop-text">Drag & drop KML file here</p>
                                <p class="drop-subtext">or</p>
                                <button type="button" class="btn btn-secondary" id="selectKmlFileBtn">Browse
                                    Files</button>
                                <input type="file" id="kmlFileInput" accept=".kml,.xml,.xlsx,.xls" hidden
                                    aria-label="Upload KML or Excel File">
                            </div>

                            <div class="csv-info">
                                <h3>KML Support</h3>
                                <p>Supports KML files with Placemarks containing Points.</p>
                                <p class="csv-note">Styles (color, scale) will be imported if available.</p>
                            </div>

                            <div id="kmlPreview" class="csv-preview d-none">
                                <h3>Preview</h3>
                                <div id="kmlPreviewContent"></div>
                                <div class="preview-actions">
                                    <button id="importKmlBtn" class="btn btn-primary" type="button">Import KML</button>
                                    <button id="debugImportBtn" class="btn btn-warning-filled" type="button"
                                        onclick="console.log('Debug click'); importKmlData()">Debug Import</button>
                                    <button id="cancelKmlBtn" class="btn btn-secondary" type="button">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- KML List Tab -->
                    <div class="tab-pane" id="kml-list-tab">
                        <div class="sites-list-header">
                            <h3>KML List <span id="kmlTotalCount" class="kml-count"></span></h3>
                            <div class="d-flex gap-sm">
                                <input type="text" id="searchKmlList" class="search-input mb-0"
                                    placeholder="Search KML...">
                                <button id="analyzeKmlBtn" class="btn btn-sm btn-primary btn-purple"
                                    title="Analyze Map">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                </button>
                                <button id="clearKmlDataBtn" class="btn btn-sm btn-secondary btn-danger-outline"
                                    title="Clear All KML Data">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path
                                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                        </path>
                                    </svg>
                                </button>
                                <button id="exportAttributesBtn" class="btn btn-sm btn-primary btn-success"
                                    title="Export Attributes to CSV">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="kmlListContainer" class="sites-list-container">
                            <!-- KML Groups will be added here -->
                        </div>
                    </div>

                    <!-- Points List Tab -->
                    <div class="tab-pane" id="points-list-tab">
                        <div class="sites-list-header">
                            <h3>Points List</h3>
                            <input type="text" id="searchPointsList" class="search-input"
                                placeholder="Search points...">
                        </div>
                        <div id="pointsListContainer" class="sites-list-container">
                            <!-- Points will be added here -->
                        </div>
                    </div>

                    <!-- Thematic Analysis Tab -->
                    <div class="tab-pane" id="thematic-tab">
                        <div class="thematic-section">
                            <h3>Thematic Analysis</h3>
                            <p class="text-muted mb-3">Color-code map sectors based on
                                attributes.</p>
                            <div class="thematic-controls">
                                <!-- Site Sectors Section -->
                                <div class="analysis-section">
                                    <h4 class="mb-2 text-primary">Site Sectors Analysis
                                    </h4>
                                    <div class="form-group">
                                        <label for="siteAttribute">Select Attribute</label>
                                        <select id="siteAttribute" class="form-control">
                                            <option value="n_a">N#A</option>
                                            <option value="technology">Technology</option>
                                            <option value="frequency">Frequency</option>
                                            <option value="azimuth">Azimuth</option>
                                            <option value="beamwidth">Beamwidth</option>
                                            <option value="range">Range</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- KML Points Section -->
                                <div class="analysis-section mb-3">
                                    <h4 class="mb-2 text-primary">KML Points Analysis
                                    </h4>
                                    <div class="form-group">
                                        <label for="kmlAttribute">Select Attribute</label>
                                        <select id="kmlAttribute" class="form-control">
                                            <option value="n_a">N#A</option>
                                            <!-- Populated dynamically -->
                                        </select>
                                    </div>
                                </div>

                                <div class="form-actions mt-3">
                                    <button id="applyThematicBtn" class="btn btn-primary btn-block">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M2 12h20M2 12l5-5m-5 5l5 5" />
                                        </svg>
                                        Analyze Map
                                    </button>
                                    <button id="clearThematicBtn" class="btn btn-secondary btn-block mt-2">
                                        Clear Analysis
                                    </button>
                                </div>

                                <div id="thematicLegend" class="thematic-legend d-none mt-4">
                                    <h4>Legend</h4>
                                    <div id="legendContent"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Sites List (Only visible in Manual/CSV/Airtable tabs - handled via CSS or JS? Actually, let's keep it simple and just toggle visibility based on tab) -->
                        <!-- Wait, the existing Sites List is outside the tab-content. I should probably move it into the manual/csv/airtable tabs OR make it a separate section. 
                     The user wants a "Points List like Sites List". 
                     Let's make the "Sites List" visible for Manual/CSV/Airtable, and "Points List" for Points tab.
                -->

                        <!-- Sites List -->
                        <!-- Sites List (Visible for Manual, CSV, Airtable) -->
                        <div id="sitesListSection" class="sites-list">
                            <div class="sites-list-header">
                                <h3>Sites List</h3>
                                <div class="d-flex gap-sm">
                                    <input type="text" id="searchSites" class="search-input mb-0"
                                        placeholder="Search sites...">
                                    <button id="analyzeSitesBtn" class="btn btn-sm btn-primary btn-purple"
                                        title="Analyze Map">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="sitesListContainer" class="sites-list-container">
                                <div class="empty-state">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="1">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                        <circle cx="12" cy="10" r="3" />
                                    </svg>
                                    <p>No sites added yet</p>
                                    <p class="empty-subtext">Add sites manually, import from CSV, or connect to Airtable
                                    </p>
                                </div>
                            </div>
                        </div>
            </aside>

            <!-- Map Container -->
            <main class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <!-- Drag Handle -->
                    <div class="drag-handle" title="Drag to move">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="9" cy="12" r="1"></circle>
                            <circle cx="9" cy="5" r="1"></circle>
                            <circle cx="9" cy="19" r="1"></circle>
                            <circle cx="15" cy="12" r="1"></circle>
                            <circle cx="15" cy="5" r="1"></circle>
                            <circle cx="15" cy="19" r="1"></circle>
                        </svg>
                    </div>
                    <!-- Toggle Button -->
                    <button id="toggleMapControlsBtn" class="toggle-controls-btn" title="Toggle Controls">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                    </button>

                    <!-- Collapsible Content -->
                    <div id="mapControlsContent" class="controls-wrapper">
                        <div class="search-container-styled">
                            <input type="text" id="addressSearch" placeholder="Search address..."
                                class="search-input w-200 mb-0">
                            <div id="searchSuggestions" class="search-suggestions"></div>
                            <button id="searchAddressBtn" class="btn btn-primary p-2" title="Search Address">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="controls-stack mt-2">
                            <button id="locateBtn" class="btn btn-primary" title="Locate Me">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                                </svg>
                            </button>
                            <button id="addMarkerBtn" class="btn btn-primary" title="Click to Add Marker">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                    <line x1="12" y1="5" x2="12" y2="15"></line>
                                    <line x1="7" y1="10" x2="17" y2="10"></line>
                                </svg>
                            </button>
                            <button id="measureBtn" class="btn btn-secondary" title="Measure Distance">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M2 12h20M2 12l5-5m-5 5l5 5" />
                                </svg>
                            </button>
                            <button id="clearMeasureBtn" class="btn btn-secondary" title="Clear Measurements">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="3 6 5 6 21 6" />
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                            </button>
                            <button id="toggleNamesBtn" class="btn btn-secondary" title="Toggle Site Names">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="7 10 12 15 17 10" />
                                    <line x1="12" y1="15" x2="12" y2="3" />
                                </svg>
                                Names
                            </button>
                            <button id="toggleSectorNamesBtn" class="btn btn-secondary" title="Toggle Sector Names">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Sectors
                            </button>
                            <!-- Connection Lines Toggle -->
                            <div class="control-group"></div>
                        </div>
                        <div class="controls-stack mt-2">
                            <button id="centerMapBtn" class="btn btn-secondary" title="Center Map">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="3" />
                                    <line x1="12" y1="1" x2="12" y2="3" />
                                    <line x1="12" y1="21" x2="12" y2="23" />
                                    <line x1="1" y1="12" x2="3" y2="12" />
                                    <line x1="21" y1="12" x2="23" y2="12" />
                                </svg>
                            </button>
                        </div>
                        <!-- Keeping original order -->
                    </div> <!-- End Wrapper -->
                </div>
        </div>
        </main>
    </div>
    </div>

    <!-- Modal for Site Details -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalSiteName">Site Details</h2>
                <button class="modal-close" id="modalCloseBtn" title="Close">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Modal for Export Options -->
    <div id="exportModal" class="modal">
        <div class="modal-content modal-width-sm">
            <div class="modal-header">
                <h2>Export Options</h2>
                <button class="modal-close" id="exportModalCloseBtn" title="Close">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p>Choose what you want to include in the KML file:</p>
                <div class="export-options">
                    <button id="exportSitesOnlyBtn" class="btn btn-secondary btn-block mb-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        Sites Only (Points)
                    </button>
                    <button id="exportFullBtn" class="btn btn-primary btn-block">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Sites & Sectors (Polygons)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Bulk Edit -->
    <div id="bulkEditModal" class="modal">
        <div class="modal-content modal-width-sm">
            <div class="modal-header">
                <h2>Bulk Edit Sectors</h2>
                <button class="modal-close" id="bulkEditModalCloseBtn" title="Close">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p>Update settings for <strong>ALL</strong> sectors in all sites.</p>
                <form id="bulkEditForm">
                    <div class="form-group">
                        <label for="bulkBeamwidth">Beamwidth (°)</label>
                        <input type="number" id="bulkBeamwidth" min="1" max="360"
                            placeholder="Leave empty to keep current">
                    </div>
                    <div class="form-group">
                        <label for="bulkRange">Range (m)</label>
                        <input type="number" id="bulkRange" min="1" placeholder="Leave empty to keep current">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-block">Apply to All</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal for Alarms -->
    <div id="alarmsModal" class="modal">
        <div class="modal-content modal-content-lg">
            <div class="modal-header">
                <h2 id="alarmsModalTitle">Site Alarms</h2>
                <button class="modal-close" id="alarmsModalCloseBtn" title="Close">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body overflow-auto flex-1">
                <div id="alarmsTableContainer">
                    <!-- Table will be injected here -->
                </div>
            </div>
            <div class="modal-footer pt-3 border-top text-right">
                <button class="btn btn-secondary" id="alarmsModalCloseBtnBottom">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Point Modal -->
    <div id="editSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="editSiteTitle">Add Point</h2>
                <button class="close-btn" onclick="closePointModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editSiteForm">
                    <div class="form-group">
                        <label for="editSiteName">Name *</label>
                        <input type="text" id="editSiteName" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editSiteLat">Latitude *</label>
                            <input type="number" id="editSiteLat" step="any" required>
                        </div>
                        <div class="form-group">
                            <label for="editSiteLng">Longitude *</label>
                            <input type="number" id="editSiteLng" step="any" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pointShape">Icon Shape</label>
                            <select id="pointShape">
                                <option value="circle">Circle</option>
                                <option value="square">Square</option>
                                <option value="triangle">Triangle</option>
                                <option value="star">Star</option>
                                <option value="diamond">Diamond</option>
                                <option value="3d-sphere">3D Sphere</option>
                                <option value="3d-cube">3D Cube</option>
                                <option value="3d-cylinder">3D Cylinder</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pointSize">Size (px)</label>
                            <input type="number" id="pointSize" value="30" min="10" max="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="pointColor">Icon Color</label>
                        <div class="d-flex gap-10">
                            <input type="color" id="pointColor" value="#ef4444" class="h-40 w-60 p-0">
                            <input type="text" id="pointColorText" value="#ef4444" placeholder="#ef4444" class="flex-1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editSiteDescription">Description</label>
                        <textarea id="editSiteDescription" rows="3"></textarea>
                    </div>

                    <div id="customPropertiesSection" class="custom-props-section">
                        <label class="custom-props-label">Custom Properties</label>
                        <div id="customPropertiesContainer">
                            <!-- Custom properties will be added here -->
                        </div>
                        <button type="button" id="addPropertyBtn" class="btn btn-secondary btn-add-prop">
                            + Add Property
                        </button>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePointModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Point</button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="app.js?v=155"></script>
</body>

</html>